<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head}"></head>
<body class="bg-light">

    <div class="d-flex" id="wrapper">
        <div id="sidebar-wrapper">
            <div th:replace="~{fragments/sidebar :: sidebar(currentUri=${currentUri})}"></div>
        </div>

        <div id="page-content-wrapper" class="w-100">
            <div th:replace="~{fragments/header :: header}"></div>

            <main class="container-fluid p-4">
                
                <form th:action="@{/proyectos/checklist/guardar-todo/{id}(id=${proyecto.id})}" method="post">
                    <div class="d-flex justify-content-between align-items-end mb-4">
                        <div>
                            <h6 class="text-uppercase text-muted small fw-bold mb-1">Proyecto Activo</h6>
                            <span class="badge bg-secondary fs-6" th:text="${proyecto.numeroParte}">NUM</span>
                            <span class="ms-2 fw-bold text-dark fs-5" th:text="${proyecto.nombre}">Nombre</span>
                        </div>
                        <div>
                            <a href="/" class="btn btn-outline-secondary btn-sm me-2">Volver</a>
                            <button type="submit" class="btn btn-je-primary btn-sm"><i class="bi bi-save me-2"></i>Guardar Cambios</button>
                        </div>
                    </div>

                    <ul class="nav nav-tabs nav-fill mb-4 border-bottom-0" id="apqpTabs" role="tablist">
                        <li class="nav-item" role="presentation" th:each="fase : ${fases}">
                            <button class="nav-link border-0 shadow-sm me-2" 
                                    th:classappend="'bg-light text-muted'"
                                    th:id="'tab-' + ${fase.id}" 
                                    data-bs-toggle="tab" 
                                    th:data-bs-target="'#content-' + ${fase.id}" 
                                    type="button" role="tab" 
                                    th:text="${fase.nombre}">
                                Fase
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="apqpTabsContent">
                        <div th:each="fase, faseIter : ${fases}" 
                             class="tab-pane fade" 
                             th:classappend="${faseIter.index == 0} ? 'show active'" 
                             th:id="'content-' + ${fase.id}" 
                             role="tabpanel">

                            <!-- Pestaña: Programa APQP -->
                            <div th:if="${fase.nombre.contains('Programa')}" class="card border-0 shadow-sm">
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                    <table class="table table-hover table-bordered mb-0 align-middle" style="font-size: 0.85rem;">
                                            <thead class="bg-light small text-uppercase text-muted fw-bold">
                                                <tr>
                                                    <th rowspan="2" style="width: 5%;" class="text-center align-middle">Champion</th>
                                                    <th rowspan="2" style="width: 8%;" class="text-center align-middle">Etapas / Stages (APQP)</th>
                                                    <th rowspan="2" style="width: 25%;" class="align-middle">Entregables / Deliverables</th>
                                                    <th colspan="2" style="width: 15%;" class="text-center">Fechas</th>
                                                    <th rowspan="2" style="width: 28%;" class="text-center align-middle">Status</th>
                                                    <th rowspan="2" style="width: 10%;" class="text-center align-middle">Calificación / Score</th>
                                                    <th rowspan="2" style="width: 14%;" class="align-middle">Observaciones / Remarks</th>
                                                </tr>
                                                <tr class="text-center">
                                                    <th style="width: 7.5%;">Plan</th>
                                                    <th style="width: 7.5%;">Real</th>
                                                </tr>
                                            </thead>                                        <tbody>
                                            <th:block th:each="item, iterStat : ${fase.items}">
                                                <!-- Fila de Grupo -->
                                                <tr th:if="${iterStat.index == 0 or !fase.items[iterStat.index - 1].etapaVisual.equals(item.etapaVisual)}" class="table-group-header">
                                                    <td colspan="8" class="fw-bold text-uppercase py-2 px-3 text-dark">
                                                        <i class="bi bi-collection me-2"></i><span th:text="${item.etapaVisual}"></span>
                                                    </td>
                                                </tr>
                                                
                                                <!-- Primera Fila (Plan) -->
                                                <tr>
                                                    <td class="text-center fw-bold" rowspan="2" style="vertical-align: middle;">
                                                        <span class="badge w-100" th:classappend="${'champ-' + #strings.toLowerCase(item.champion.split('/')[0])}" th:text="${item.champion}"></span>
                                                    </td>
                                                    <td rowspan="2" style="vertical-align: middle;" class="small text-muted text-center" th:text="${item.etapaVisual}"></td>
                                                    <td rowspan="2" style="vertical-align: middle; background-color: #fffacd;">
                                                        <span class="d-block fw-bold text-dark" th:text="${item.nombre}"></span>
                                                    </td>
                                                    <td class="fw-bold small ps-2">Plan</td>
                                                    <td class="text-center">
                                                        <input type="date" class="form-control form-control-sm border-0 bg-transparent text-center p-0" th:name="'fechaPlan-' + ${item.id}" th:value="${item.fechaPlan}">
                                                    </td>
                                                    <td class="text-center" rowspan="2" style="vertical-align: middle;">
                                                        <select class="form-select form-select-sm border-0 fw-bold" th:name="'controlEntregable-' + ${item.id}"
                                                                th:classappend="${
                                                                    item.controlEntregable == 'Closed on time' ? 'status-on-time' :
                                                                    (item.controlEntregable == 'Closed late' ? 'status-late' :
                                                                    (item.controlEntregable == 'DECISION' ? 'status-decision' :
                                                                    (item.controlEntregable == 'NEEDS ACTION' ? 'status-needs-action' : 'status-default')))}">
                                                            <option th:selected="${item.controlEntregable == 'Closed on time'}" value="Closed on time">Closed on time</option>
                                                            <option th:selected="${item.controlEntregable == 'Closed late'}" value="Closed late">Closed late</option>
                                                            <option th:selected="${item.controlEntregable == 'DECISION'}" value="DECISION">DECISION</option>
                                                            <option th:selected="${item.controlEntregable == 'NEEDS ACTION'}" value="NEEDS ACTION">NEEDS ACTION</option>
                                                        </select>
                                                    </td>
                                                    <td class="text-center" rowspan="2" style="vertical-align: middle;">
                                                        <select class="form-select form-select-sm border-0 fw-bold" th:name="'score-' + ${item.id}"
                                                                th:classappend="${item.score == 'OK' ? 'status-on-time' : 'status-default'}">
                                                            <option th:selected="${item.score == 'OK'}" value="OK">OK</option>
                                                            <option th:selected="${item.score == 'N/A'}" value="N/A">N/A</option>
                                                        </select>
                                                    </td>
                                                    <td rowspan="2" style="vertical-align: middle;">
                                                        <textarea class="form-control form-control-sm border-0 bg-light-subtle" rows="2" 
                                                                  th:name="'comentario-' + ${item.id}"
                                                                  th:text="${item.comentario}" placeholder="..."></textarea>
                                                    </td>
                                                </tr>
                                                
                                                <!-- Segunda Fila (Real) -->
                                                <tr>
                                                    <td class="fw-bold small ps-2">Real</td>
                                                    <td class="text-center">
                                                        <input type="date" class="form-control form-control-sm border-0 bg-light-subtle text-center p-0" th:name="'fechaReal-' + ${item.id}" th:value="${item.fechaReal}">
                                                    </td>
                                                </tr>
                                            </th:block>
                                        </tbody>
                                    </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Pestaña: Stage 2 -->
                            <div th:if="${fase.nombre.contains('Stage 2')}" class="card border-0 shadow-sm">
                                <div class="card-body p-0">
                                    <table class="table table-hover mb-0 align-middle" style="font-size: 0.85rem;">
                                        <thead class="bg-light small fw-bold text-uppercase">
                                            <tr>
                                                <th style="width: 10%;">ID</th>
                                                <th style="width: 35%;">Requisito / Requirement</th>
                                                <th style="width: 15%;">Cumplimiento</th>
                                                <th style="width: 25%;">Comentarios</th>
                                                <th style="width: 10%;">Responsable</th>
                                                <th style="width: 10%;">Fecha</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <th:block th:each="item, iterStat : ${fase.items}">
                                                <tr th:if="${iterStat.index == 0 || !fase.items[iterStat.index - 1].grupo.equals(item.grupo)}" class="table-secondary">
                                                    <td colspan="6" class="fw-bold text-uppercase small py-1 px-3 text-dark">
                                                        <i class="bi bi-folder2-open me-2"></i><span th:text="${item.grupo}">Grupo</span>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="text-muted fw-bold text-center" th:text="${item.codigo}"></td>
                                                    <td th:text="${item.nombre}" class="fw-bold text-dark"></td>
                                                    <td class="text-center">
                                                        <div class="btn-group btn-group-sm w-100">
                                                            <input type="radio" class="btn-check" th:name="'estado-' + ${item.id}" value="OK" th:id="'si_'+${item.id}" th:checked="${item.estado == 'OK'}">
                                                            <label class="btn btn-outline-success" th:for="'si_'+${item.id}">Si</label>
                                                            <input type="radio" class="btn-check" th:name="'estado-' + ${item.id}" value="NOK" th:id="'no_'+${item.id}" th:checked="${item.estado == 'NOK'}">
                                                            <label class="btn btn-outline-danger" th:for="'no_'+${item.id}">No</label>
                                                            <input type="radio" class="btn-check" th:name="'estado-' + ${item.id}" value="NA" th:id="'na_'+${item.id}" th:checked="${item.estado == 'NA'}">
                                                            <label class="btn btn-outline-secondary" th:for="'na_'+${item.id}">NA</label>
                                                        </div>
                                                    </td>
                                                    <td><textarea class="form-control form-control-sm border-0 bg-light-subtle" rows="1" th:name="'comentario-' + ${item.id}" th:text="${item.comentario}"></textarea></td>
                                                    <td class="text-center small text-primary fw-bold" th:text="${item.champion}"></td>
                                                    <td class="text-center"><input type="date" class="form-control form-control-sm border-0 text-center p-0" th:name="'fechaReal-' + ${item.id}" th:value="${item.fechaReal}"></td>
                                                </tr>
                                            </th:block>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Pestaña: Gate Reviews -->
                            <div th:if="${!fase.nombre.contains('Programa') && !fase.nombre.contains('Stage 2')}" class="card border-0 shadow-sm">
                               <div class="card-body p-4">
                                    <div class="p-3 mb-4 rounded" style="background-color: #f8f9fa;">
                                        <h4 class="fw-bold text-dark mb-3" th:text="'Revisión de Etapa / ' + ${fase.nombre}"></h4>
                                        <div class="row g-3">
                                            <div class="col-md-6"><strong class="me-2">Cliente/Customer:</strong> <span th:text="${proyecto.cliente}"></span></div>
                                            <div class="col-md-6"><strong class="me-2">Fecha/Date:</strong> <span></span></div>
                                            <div class="col-md-6"><strong class="me-2">Nombre del proyecto/Project Name:</strong> <span th:text="${proyecto.nombre}"></span></div>
                                            <div class="col-md-6"><strong class="me-2">Número de parte/Part Number:</strong> <span th:text="${proyecto.numeroParte}"></span></div>
                                        </div>
                                    </div>
                                    <h6 class="text-uppercase fw-bold text-secondary mb-3 border-bottom pb-2">1. Validación de Requerimientos</h6>
                                    <div class="table-responsive mb-5">
                                        <table class="table table-bordered mb-0 align-middle">
                                            <thead class="bg-light small fw-bold text-center">
                                                <tr>
                                                    <th style="width: 5%;">Si/Yes</th>
                                                    <th style="width: 5%;">No</th>
                                                    <th>Requerimiento/Requirement</th>
                                                    <th style="width: 30%;">Comentarios/Comments</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="item : ${fase.items}" th:if="${item.grupo == 'Validación'}">
                                                    <td class="text-center"><input class="form-check-input" type="radio" th:name="'estado-' + ${item.id}" value="OK" th:checked="${item.estado == 'OK'}"></td>
                                                    <td class="text-center"><input class="form-check-input" type="radio" th:name="'estado-' + ${item.id}" value="NOK" th:checked="${item.estado == 'NOK'}"></td>
                                                    <td class="fw-bold" th:text="${item.nombre}"></td>
                                                    <td><textarea class="form-control form-control-sm border-0 bg-light-subtle" rows="1" th:name="'comentario-' + ${item.id}" th:text="${item.comentario}"></textarea></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <h6 class="text-uppercase fw-bold text-secondary mb-3 border-bottom pb-2">2. Conclusión de la Etapa</h6>
                                    <div class="table-responsive mb-5">
                                        <table class="table table-bordered mb-0 align-middle">
                                            <thead class="bg-light small fw-bold text-center">
                                                <tr>
                                                    <th style="width: 15%;">Fecha / Date</th>
                                                    <th style="width: 20%;">Conclusión / Conclusion</th>
                                                    <th>Descripción</th>
                                                    <th style="width: 25%;">Comentarios /Comments</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="item : ${fase.items}" th:if="${item.grupo == 'Conclusión'}">
                                                    <td><input type="date" class="form-control form-control-sm border-0 text-center" th:name="'fechaReal-' + ${item.id}" th:value="${item.fechaReal}"></td>
                                                    <td><strong th:text="${item.nombre.split(':')[0]}"></strong></td>
                                                    <td th:text="${item.nombre.split(':').length > 1 ? item.nombre.split(':')[1] : ''}"></td>
                                                    <td><textarea class="form-control form-control-sm border-0 bg-light-subtle" rows="1" th:name="'comentario-' + ${item.id}" th:text="${item.comentario}"></textarea></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <h6 class="text-uppercase fw-bold text-secondary mb-3 border-bottom pb-2">3. Aprobaciones / Approvals</h6>
                                    <div th:if="${fase.nombre == 'Stage 3'}">
                                        <strong class="d-block mb-2">Stage 3 Responsibles</strong>
                                        <table class="table table-sm table-bordered small">
                                            <thead class="bg-light"><tr><th>Position</th><th>Name</th><th>Email</th></tr></thead>
                                            <tbody>
                                                <tr><td>Project Engineer</td><td>Eduardo Tejeida</td><td>eduardo.tejeida@johnsonelectric.com</td></tr>
                                                <tr><td>Quality Engineer</td><td>Gabriel Romero</td><td>gabriel.romero@johnsonelectric.com</td></tr>
                                                <tr><td>Process Engineer</td><td>Jesus Urena</td><td>jesus.urena@johnsonelectric.com</td></tr>
                                                <tr><td>Project Leader</td><td>Eduardo Tejeida</td><td>eduardo.tejeida@johnsonelectric.com</td></tr>
                                            </tbody>
                                        </table>
                                        <strong class="d-block mb-2 mt-4">Manufacturing site Management</strong>
                                        <table class="table table-sm table-bordered small">
                                            <thead class="bg-light"><tr><th>Position</th><th>Name</th><th>Email</th></tr></thead>
                                            <tbody>
                                                <tr><td>Operations Manager</td><td>Fermin Flores</td><td>fermin.flores@johnsonelectric.com</td></tr>
                                                <tr><td>Quality Manager</td><td>Rodrigo Rabelo</td><td>rodrigo.rabelo@johnsonelectric.com</td></tr>
                                                <tr><td>Materials Manager</td><td>Juan Carlos Arizpe</td><td>Juancarlos.arizpe@johnsonelectric.com</td></tr>
                                                <tr><td>SCS Manager</td><td>Kevin Swisher</td><td>kevin.swisher@jonsonelectric.com</td></tr>
                                                <tr><td>Finance Manager</td><td>Bernardo Marines</td><td>Bernardo.marines@johnsonelectric.com</td></tr>
                                                <tr><td>HR Manager</td><td>Claudia Castañeda</td><td>claudia.castaneda@johnsonelectric.com</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div th:if="${fase.nombre != 'Stage 3'}" class="text-muted">
                                        (Tabla de Aprobaciones para <span th:text="${fase.nombre}"></span> no definida)
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Lógica para recordar y activar la última pestaña seleccionada
        document.addEventListener('DOMContentLoaded', function() {
            const apqpTabs = document.getElementById('apqpTabs');
            if (apqpTabs) {
                const tabButtons = apqpTabs.querySelectorAll('button[data-bs-toggle="tab"]');
                const lastActiveTabId = localStorage.getItem('lastActiveApqpTab');
                let tabToActivate = null;
                if (lastActiveTabId) {
                    tabToActivate = document.getElementById(lastActiveTabId);
                }
                if (!tabToActivate || !apqpTabs.contains(tabToActivate)) {
                    tabToActivate = tabButtons[0];
                }
                if (tabToActivate) {
                    const bootstrapTab = new bootstrap.Tab(tabToActivate);
                    bootstrapTab.show();
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active', 'fw-bold', 'bg-white');
                        btn.classList.add('bg-light', 'text-muted');
                    });
                    tabToActivate.classList.add('active', 'fw-bold', 'bg-white');
                    tabToActivate.classList.remove('bg-light', 'text-muted');
                }
                apqpTabs.addEventListener('click', function(event) {
                    const clickedButton = event.target.closest('button[data-bs-toggle="tab"]');
                    if (clickedButton) {
                        localStorage.setItem('lastActiveApqpTab', clickedButton.id);
                        tabButtons.forEach(btn => {
                            btn.classList.remove('active', 'fw-bold', 'bg-white');
                            btn.classList.add('bg-light', 'text-muted');
                        });
                        clickedButton.classList.add('active', 'fw-bold', 'bg-white');
                        clickedButton.classList.remove('bg-light', 'text-muted');
                    }
                });
            }
        });
    </script>
</body>
</html>